# CalcCraft — Local Contract (No HTTP)

This repository follows a **local-only** contract. Although the global contract shape mentions a `GET /health` endpoint, **this Android-only app MUST NOT implement any HTTP server and MUST NOT make network calls**.

Instead, `GET /health` is represented as an **in-app health check function** that returns a `HealthStatus` data model.

---

## 1) “Endpoint”: `GET /health` (local-only)

### Meaning
A diagnostic function used by tests/diagnostics to verify:
- the app is running,
- the expression evaluation engine is available.

### Implementation requirement (no HTTP)
Implement as an in-app function, e.g.:
- `HealthCheck.check(context): HealthStatus`

### Response model: `HealthStatus`
- `status` (string, required): MUST be `"ok"` when functional.
- `app` (string, required): MUST be `"CalcCraft"`.
- `version` (string, required): app version name.

---

## 2) Data models

### 2.1 `EvalResult`
Result of safely evaluating an expression. **Exactly one of success or error must be set.**

Fields:
- `type` (string, required): one of:
  - `"success"`
  - `"error"`

When `type == "success"`:
- `value` (double, optional): raw numeric value.
- `formatted` (string, optional): display-ready formatting.
  - MUST trim trailing zeros.
  - MUST avoid trailing decimal point (e.g., `"2."` is not allowed; use `"2"`).

When `type == "error"`:
- `error_kind` (string, optional): one of:
  - `"DivideByZero"`
  - `"InvalidSyntax"`
  - `"UnknownToken"`
  - `"MismatchedParentheses"`
  - `"DomainError"`
  - `"Overflow"`
  - `"StackUnderflow"`
- `message` (string, optional): user-friendly message suitable for UI.

### 2.2 `HistoryEntry`
In-memory history item representing one evaluation attempt.

Fields:
- `id` (string, required): unique identifier (e.g., UUID).
- `timestamp_ms` (long, required): epoch milliseconds.
- `expression` (string, required): user-entered expression string.
- `result` (`EvalResult`, required): evaluation outcome.

Constraints:
- History MUST be **in-memory only**.
- History MUST be cleared on app/process death.
- Clearing history MUST remove all entries from the current state.

### 2.3 `CalculatorState`
Single source of truth for UI state (managed by reducer/ViewModel).

Fields:
- `current_expression` (string, required)
- `last_result` (string, optional)
- `error_message` (string, optional)
- `history` (list of `HistoryEntry`, required)
- `destination` (string, required): one of:
  - `"calculator"`
  - `"history"`

### 2.4 `CalculatorIntent`
Reducer intents generated by UI buttons and hardware keyboard mapping.

Fields:
- `type` (string, required): one of:
  - `"Append"`
  - `"Delete"`
  - `"Clear"`
  - `"Evaluate"`
  - `"ClearHistory"`
  - `"SwitchDestination"`
  - `"UseHistoryEntry"`
- `text` (string, optional): for `Append`
- `destination` (string, optional): for `SwitchDestination` (`"calculator"` | `"history"`)
- `history_entry_id` (string, optional): for `UseHistoryEntry`

---

## 3) Expression evaluation contract

### 3.1 Safety and determinism
Evaluation MUST be implemented via:
1. **Tokenizer** (string → tokens)
2. **Shunting-yard** (tokens → RPN)
3. **RPN evaluator** (RPN → result)

Forbidden:
- JavaScript engines
- reflection-based evaluation
- any `eval`-like execution

### 3.2 Supported tokens

#### Numbers
- Decimal numbers with optional fractional part.
  - Examples: `1`, `1.0`, `.5` (if supported by tokenizer), `0.5`, `12.34`
- Whitespace may appear anywhere and MUST be ignored.

#### Operators
Binary:
- `+` addition
- `-` subtraction
- `*` multiplication
- `/` division

Unary:
- unary minus `-x` (negation)

Postfix:
- percent `%` (see percent behavior below)

#### Parentheses
- `(` and `)`

#### Constants
- `pi` (π)
- `e` (Euler’s number)

#### Functions
- `sin(x)`
- `cos(x)`
- `tan(x)`
- `log(x)` (natural logarithm)
- `sqrt(x)`
- `pow(a,b)`

Arguments:
- Functions use parentheses.
- `pow` takes **two** arguments separated by a comma: `pow(2,3)`.

### 3.3 Operator precedence and associativity
From highest to lowest:

1. **Functions** (e.g., `sin(...)`, `pow(...,...)`) — bind to their argument list.
2. **Unary minus** (negation) — right-associative.
3. **Percent** (`%`) — postfix, applies to the immediately preceding value/expression.
4. Multiplication/division: `*` `/` — left-associative.
5. Addition/subtraction: `+` `-` — left-associative.

Parentheses override precedence.

Examples (expected parsing intent):
- `-3^` is not applicable (no exponent operator). Unary minus applies tightly: `-3*2` = `(-3)*2`.
- `-(2+1)` is valid.
- `50%` applies percent to `50`.

### 3.4 Percent behavior
Percent is a postfix operator.

Definition:
- `x%` evaluates to `x / 100`.

Examples:
- `50%` → `0.5`
- `200 * 10%` → `200 * 0.1` → `20`
- `1 + 5%` → `1.05`

Notes:
- This is the **mathematical** percent operator behavior and does not implement “calculator-style percent of previous term” variants.

### 3.5 Function domains
If a function input is outside its domain, evaluation MUST return an error:
- `sqrt(x)` where `x < 0` → `DomainError`
- `log(x)` where `x <= 0` → `DomainError`

`tan(x)` may become very large near asymptotes; implementations SHOULD handle non-finite values as errors (see Overflow/DomainError guidance below).

### 3.6 Division by zero
- Any division by zero MUST return:
  - `type = "error"`
  - `error_kind = "DivideByZero"`

### 3.7 Error kinds and when to use them
The engine MUST be robust and never crash on malformed input.

Use these error kinds:
- `InvalidSyntax`
  - e.g., `"1+"`, `"*2"`, `"( )"` (empty), `"1..2"`, missing function parenthesis, misplaced comma
- `UnknownToken`
  - e.g., any unexpected character or identifier not in the supported set
- `MismatchedParentheses`
  - e.g., `"(1+2"` or `"1+2)"`
- `DivideByZero`
  - e.g., `"1/0"`, `"1/(2-2)"`
- `DomainError`
  - e.g., `"sqrt(-1)"`, `"log(0)"`, `"log(-3)"`
- `Overflow`
  - result is not finite (NaN/Infinity) or intermediate calculations exceed safe range
- `StackUnderflow`
  - internal evaluator stack does not have enough operands for an operator/function

User message requirements:
- `message` MUST be user-friendly and suitable for display.
- The UI should show `message` and store the attempt in history.

---

## 4) History and UI invariants

- Every evaluation attempt (success or error) SHOULD be appended to history as a `HistoryEntry`.
- History order recommendation: most recent first.
- `UseHistoryEntry` MUST load the chosen entry’s `expression` into `current_expression`.
- Switching destination MUST only allow `"calculator"` and `"history"`.

---

## 5) Hardware keyboard mapping invariants

Minimum required keyboard support:
- Digits `0-9` append their character.
- Operators `+ - * /` append.
- Parentheses `(` `)` append.
- Decimal point `.` appends.
- `Enter` triggers `Evaluate`.
- `Backspace` triggers `Delete`.
- `Escape` may trigger `Clear` (optional).

Mapping must be covered by unit tests at reducer/mapper boundaries.

---

## 6) Non-goals and prohibitions

- MUST NOT implement an HTTP server.
- MUST NOT perform network calls.
- MUST NOT add auth/session.
- MUST NOT add persistence (no Room/SQLite/DataStore). History is in-memory only.

---

## 7) Compatibility note

This contract is designed to be small and deterministic so that:
- unit tests can validate engine correctness,
- UI logic can remain predictable,
- evaluation errors can be handled without crashes.
